Tags：RKCP

RKCP设计说明
====

---

[TOC]

---

RKCP是用于RPC底层传输的通信协议，使用UDP协议+KCP协议实现。

###1.主要特性
- 自动管理连接
- 面向响应式消息传递设计
- 适用于局域网内快速报文通信
- 适用于客户端与服务器间数据通信

###2.使用限制
- 所有参与通信的终端IP地址前两字节必须相同
- 客户端只能单线程呼叫同一服务（服务器IP+端口号）

###3.连接自动管理

RKCP采用自动编码的方式管理通信链路，链路标识为4字节（32位）整数，由客户端ip地址和udp端口号组成，编码方式如下：
|字节：3|字节：2|字节：1 ———— 字节：0|
|:----:|:----:|:----:|
|IP地址末字节|IP地址次末字节|IP端口号|

###4.通信模式

RKCP以类似函数调用的方式进行通信，通信过程如下：

1. CALL：呼叫 客户端将上层应用提交的应用数据组包成呼叫报文，发送给服务器
2. SERV：服务 服务器自动接收呼叫报文，解包出应用数据交给上层应用，并等待执行结果
3. RESP：回应 服务器将上层应用执行结果组包成结果报文，发送给客户端
4. SULT: 结果 客户端自动接收结果报文，解包出应用数据交给上层应用

>说明：*通信过程中自动建立连接，通信结束后连接自动关闭*

###5.通信报文

####5.1 报文格式
RKCP的通信报文格式为：包头+应用数据
应用数据是上层应用提交的原始数据，包头为8字节（64位）整数。
包头有两种类别： **呼叫报文包头** 和 **结果报文包头** 
服务器接收呼叫报文，发送结果报文，客户端则正好相反。

####5.2 呼叫报文包头

呼叫报文包头格式如下：

|比特位：63——53|比特位：52——48|比特位：47——32|比特位：31——0|
|:----:|:----:|:----:|:----:|
|RKCPID|CALLMODE|CALLID|LEN|

说明：

- RKCPID 标识
 固定值1210，用于识别RKCP报文

- CALLMODE 呼叫模式
 void call := 1 该模式下客户端只接收结果报文的包头，不接收应用数据
 data call := 2 该模式下客户端接收包头和应用数据
 push call := 3 该模式下客户端推送数据给服务器，并接收服务器进度报告
 pull call := 4 该模式下客户端从服务器拉取数据

- CALLID 呼叫id
 用于标识本次呼叫中服务器上的应用接口id，由上层应用负责维护

- LEN 数据长度
 应用数据的字节长度

####5.3 结果报文包头

结果报文包头格式如下：

|比特位：63——53|比特位：52——48|比特位：47——32|比特位：31——0|
|:----:|:----:|:----:|:----:|
|RKCPID|RESULTCODE|PERCENT|LEN|

说明：

- RKCPID 标识
 固定值1210，用于识别RKCP报文

- RESULTCODE 结果码
 结果码由上层应用设置，内置定义如下
 ok := 1
 timeout := 2
 failed := 3
 null/not_found := 4
 percent := 5

- PERCENT 进度报告
 传输进度报告值，1——10000的整数值

- LEN 数据长度
 应用数据的字节长度




